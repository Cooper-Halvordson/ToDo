<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>To Do</title>
    <style>
        .task {
            grid-area:task;
            background-color:beige;
            color : black;
            padding: 5px;
            
        }
        .resolution{
            grid-area: resolution;
            font-style : italic;
        }
        .draggable {
            grid-area: grab-box;
            cursor: move;
            background-color: #cc6600;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .status {
            grid-area: status;
            position: relative;
            display: inline-block;
        }
        .status-options {
            display: none;
            position: absolute;
            min-width: 100px;
            background-color: #f2f2f2;
            z-index: 1;
        }
        .status-options button {
            color: black;
            padding: 12px 16px;
            width: 100%;
            text-decoration: none;
            display: inline-block;
        }
        .status-options button:hover {
            background-color: #cccccc;
        }
        .status:hover .status-options {
            display: block;
        }
        .status-high {
            background-color:#ff8080;
        }
        .status-normal {
            background-color:#66ff99;
        }
        .status-hold {
            background-color:#99ccff;
        }
        .filler {
            height: 100%;
        }
        .placeholder {
            background-color: #edf2f7;
            border: 2px dashed #cbd5e0;
            margin-bottom: 1rem;
        }
        .grid-container {
            display: grid;
            column-gap: 1px;
            row-gap: 2px;
            border: 1px solid black;
            grid-template-columns: 30px 50px auto;
            grid-template-areas:
                'status grab-box task'
                'status grab-box resolution';
            border-top: 2px solid black;
            border-bottom: 2px solid black;
            border-left: 2px solid black;
            margin-bottom: 5px;
            background-color: black;
        }
        body {
            background-color: snow;
        }
    </style>
</head>
<body>
    <script>
        
        document.addEventListener('DOMContentLoaded', function() {
            //Query the list element
            const list = document.getElementById("list");

            let draggingEle;
            let placeholder;
            let isDraggingStarted = false;

            //The current position of mouse relative to the dragging element
            let x = 0;
            let y = 0;

            //Swap two nodes
            const swap = function(nodeA, nodeB) {
                const parentA = nodeA.parentNode;
                const siblingA = nodeA.nextSibling === nodeB ? nodeA : nodeA.nextSibling;

                //Move `nodeA` to before the `nodeB`
                nodeB.parentNode.insertBefore(nodeA, nodeB);

                //Move `nodeB` to before the sibling of `nodeA`
                parentA.insertBefore(nodeB, siblingA);
            };

            const isAbove = function(nodeA, nodeB) {
                //Get the bounding rectangle of nodes
                const rectA = nodeA.getBoundingClientRect();
                const rectB = nodeB.getBoundingClientRect();

                return (rectA.top + rectA.height / 2 < rectB.top + rectB.height / 2);
            };

            const mouseDownHandler = function(e) {
                draggingEle = e.target.parentElement;
                //console.log(e.target);
                //console.log(e.target.parentElement);

                //Calculate the mouse position
                const rect = draggingEle.getBoundingClientRect();
                x = e.pageX - rect.left;
                y = e.pageY - rect.top;

                // Attach the listeners to `document`
                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('mouseup', mouseUpHandler);
            };

            const mouseMoveHandler = function(e) {
                const draggingRect = draggingEle.getBoundingClientRect();

                if (!isDraggingStarted) {
                    isDraggingStarted = true;

                    //Let the placeholder take the height of dragging element
                    //so the next element won't move up.
                    placeholder = document.createElement("div");
                    placeholder.classList.add("placeholder");
                    draggingEle.parentNode.insertBefore(placeholder, draggingEle.nextSibling);
                    placeholder.style.height = `${draggingRect.height}px`;
                }

                //Set position for dragging element
                draggingEle.style.position = "absolute";
                draggingEle.style.top = `${e.pageY - y}px`;
                draggingEle.style.left = `${e.pageX - x}px`;

                //The current order:
                //prevEle
                //draggingEle
                //placeholder
                //nextEle
                const prevEle = draggingEle.previousElementSibling;
                const nextEle = placeholder.nextElementSibling;

                //The dragging element is above the previous element
                //User moves the dragging element to the top
                if (prevEle && isAbove(draggingEle, prevEle)) {
                    swap(placeholder, draggingEle);
                    swap(placeholder, prevEle);
                    return;
                }

                //The dragging element is below the next element
                //User moves the dragging element to the bottom
                if (nextEle && isAbove(nextEle, draggingEle)) {
                    swap(nextEle, placeholder);
                    swap(nextEle, draggingEle);
                }
            };

            const mouseUpHandler = function() {
                //Remove the placeholder
                placeholder && placeholder.parentNode.removeChild(placeholder);

                draggingEle.style.removeProperty('top');
                draggingEle.style.removeProperty('left');
                draggingEle.style.removeProperty('position');
                x = null;
                y = null;
                draggingEle = null;
                isDraggingStarted = false;
                //Remove the handlers of `mousemove` and `mouseup`.
                document.removeEventListener("mousemove", mouseMoveHandler);
                document.removeEventListener("mouseup", mouseUpHandler);
            };

            //Query all items
            [].slice.call(list.querySelectorAll(".draggable")).forEach(function(item) {
                item.addEventListener('mousedown', mouseDownHandler);
            });
        });
        function createTask() {
            //Create the grid block for the task.
            let block = document.createElement("div");
            block.classList.add("grid-container");

            //Create the status element.
            let status = document.createElement("div");
            status.classList.add("status");
            status.classList.add("status-normal");

            //Create status dropdown elements.
            let filler = document.createElement("div");
            filler.classList.add("filler");
            status.appendChild(filler);

            let dd = document.createElement("div");
            dd.classList.add("status-options");

            let b1 = document.createElement("button");
            b1.setAttribute("data-status", "high");
            b1.setAttribute("onClick", "changeStatus(this)");
            b1.setAttribute("type", "button");
            b1.innerHTML = "High";
            dd.appendChild(b1);

            b1 = document.createElement("button");
            b1.setAttribute("data-status", "normal");
            b1.setAttribute("onClick", "changeStatus(this)");
            b1.setAttribute("type", "button");
            b1.innerHTML = "Normal";
            dd.appendChild(b1);

            b1 = document.createElement("button");
            b1.setAttribute("data-status", "hold");
            b1.setAttribute("onClick", "changeStatus(this)");
            b1.setAttribute("type", "button");
            b1.innerHTML = "On Hold";
            dd.appendChild(b1);

            status.appendChild(dd);

            //Added move section
            let move = document.createElement("div");
            move.classList.add("draggable");
            move.innerHTML = "move";
            //move.addEventListener('mousedown', mouseDownHandler);

            //Create the task section.
            let task = document.createElement("div");
            task.classList.add("task");
            task.setAttribute("contenteditable", "true");

            //Create the resolution section.
            let resolution = document.createElement("div");
            resolution.classList.add("task");
            resolution.classList.add("resolution");
            resolution.setAttribute("contenteditable", "true");

            block.appendChild(status);
            block.appendChild(move);
            block.appendChild(task);
            block.appendChild(resolution);

            document.getElementById("list").appendChild(block);

        }
        function changeStatus(ele) {
            if (ele.getAttribute("data-status") == "high") {
                ele.parentElement.parentElement.className = "status status-high";
            }
            else if (ele.getAttribute("data-status") == "hold") {
                ele.parentElement.parentElement.className = "status status-hold";
            }
            else {
                ele.parentElement.parentElement.className = "status status-normal";
            }
        }
    </script>
    <h1>To Dos</h1>
    <div id = "list">
        <h3 id="l1">Phase 1</h3>
        <div class="grid-container">
            <div class="status status-normal">
                <div class="filler"></div>
                <div class="status-options">
                    <button data-status="high" onClick="changeStatus(this)" type="button">High</button>
                    <button data-status="normal" onClick="changeStatus(this)" type="button">Normal</button>
                    <button data-status="hold" onClick="changeStatus(this)" type="button">On Hold</button>
                </div>
            </div>
            <div class="draggable">
                move
            </div>
            <div contenteditable="true" class="task">
                Save to json file.
            </div>
            <div contenteditable="true" class="task resolution">
                None
            </div>
        </div>
        <div class="grid-container">
            <div class="status status-normal">
                <div class="filler"></div>
                <div class="status-options">
                    <button data-status="high" onClick="changeStatus(this)" type="button">High</button>
                    <button data-status="normal" onClick="changeStatus(this)" type="button">Normal</button>
                    <button data-status="hold" onClick="changeStatus(this)" type="button">On Hold</button>
                </div>
            </div>
            <div class="draggable">
                move
            </div>
            <div contenteditable="true" class="task">
                Load from json file.
            </div>
            <div contenteditable="true" class="task resolution">
                None
            </div>
        </div>
        <div class="grid-container">
            <div class="status status-high">
                <div class="filler"></div>
                <div class="status-options">
                    <button data-status="high" onClick="changeStatus(this)" type="button">High</button>
                    <button data-status="normal" onClick="changeStatus(this)" type="button">Normal</button>
                    <button data-status="hold" onClick="changeStatus(this)" type="button">On Hold</button>
                </div>
            </div>
            <div class="draggable">
                move
            </div>
            <div contenteditable="true" class="task">
               Be able to move the tasks.
            </div>
            <div contenteditable="true" class="task resolution">
                I found somethign earlier that looked good.
            </div>
        </div>
    </div>
    <button id="new_button" type="button" onclick="createTask()">New</button>
</body>
</html>